<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lúa CLC Đồng Tháp</title>
    
    <!-- Font tiếng Việt từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800;900&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
    <script src="https://unpkg.com/shpjs@3.6.2/dist/shp.js"></script>
    
    <style>
/* CSS Layout cơ bản */
html, body {
    height: 100vh; 
    margin: 0;
    padding: 0;
    font-family: 'Be Vietnam Pro', 'Roboto', Arial, sans-serif;
    overflow: hidden; 
}
#sidebar {
    position: absolute; 
    right: 0;
    top: 0;
    width: 350px; 
    height: 100vh; 
    background: #ffffff;
    padding: 0;
    box-sizing: border-box; 
    overflow-y: auto; 
    box-shadow: -2px 0 5px rgba(0,0,0,0.1); 
    z-index: 1000; 
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
}
#sidebar.sidebar-visible {
    transform: translateX(0);
}
#map {
    position: absolute; 
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 1; 
}

/* CSS Bảng thông tin */
#sidebar h2 { 
    margin: 0; 
    padding: 15px; 
    background-color: #f9f9f9; 
    border-bottom: 1px solid #ddd; 
    font-size: 18px; 
    font-family: 'Be Vietnam Pro', sans-serif;
}
#sidebar-content { 
    padding: 15px; 
}
#sidebar-content table { 
    width: 100%; 
    border-collapse: collapse; 
}
#sidebar-content thead tr { 
    background-color: #f2f2f2; 
    border-bottom: 1px solid #ddd; 
}
#sidebar-content thead th { 
    padding: 10px 8px; 
    text-align: left; 
    font-weight: bold; 
}

/* CSS tối ưu cho ô dữ liệu - KHÔNG CẮT TỪ GIỮA CHỪNG */
#sidebar-content tbody td { 
    border-bottom: 1px solid #ddd; 
    padding: 8px 8px; 
    text-align: left; 
    overflow-wrap: break-word; 
    word-break: normal;
    white-space: normal;
    hyphens: none;
    transition: background-color 0.2s; 
}

#sidebar-content tbody td:first-child { 
    width: 120px; 
    font-weight: 600;
}

#sidebar-content tbody td:hover { 
    background-color: #e6f7e6; 
    cursor: pointer; 
}

/* CSS cho tooltip */
.leaflet-tooltip.xa-label {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    transition: font-size 0.2s ease-in-out !important;
}
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Thông tin thửa đất</h2>
        <div id="sidebar-content">
            <p>Click vào một thửa đất trên bản đồ để xem thông tin.</p>
        </div>
    </div>

    <div id="map"></div>

    <script>
// 1. Khởi tạo bản đồ
const map = L.map('map').setView([10.7769, 106.7009], 10); 

// 2. Lớp bản đồ nền
const osm = L.tileLayer.provider('OpenStreetMap.Mapnik');
const esriSatellite = L.tileLayer.provider('Esri.WorldImagery').addTo(map); 
const baseMaps = {
    "OpenStreetMap": osm,
    "Vệ tinh (Esri)": esriSatellite 
};

// 3. Lớp phủ
const cartoLabels = L.tileLayer.provider('CartoDB.PositronOnlyLabels'); 
const overlayMaps = {
    "Chỉ dẫn (Đường & Địa danh)": cartoLabels
};

// 4. Bộ chọn lớp
const layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

// 5. Sidebar
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebar-content'); 
let lastClickedLayer = null;

// 6. Style cho lớp Vùng Lúa
const defaultStyle = {
    color: "#ff7800", 
    weight: 2, 
    opacity: 0.8, 
    fillColor: "#ff7800", 
    fillOpacity: 0.3
};
const highlightStyle = {
    color: "#00FFFF", 
    weight: 4, 
    opacity: 1, 
    fillColor: "#00FFFF", 
    fillOpacity: 0.5   
};

// 7. Click vào map
map.on('click', function() {
    if (lastClickedLayer) {
        lastClickedLayer.setStyle(defaultStyle); 
        lastClickedLayer = null;
    }
    sidebarContent.innerHTML = '<p>Click vào một thửa đất trên bản đồ để xem thông tin.</p>';
    sidebar.classList.remove('sidebar-visible');
});

// BIẾN LƯU TRỮ THÔNG TIN POLYGON VÀ NHÃN
let labelLayers = [];

// ===== HÀM MỚI: TÍNH FONT SIZE ĐỘNG DỰA TRÊN ZOOM VÀ KÍCH THƯỚC POLYGON =====
function calculateAdaptiveFontSize(polygonBounds, zoom, labelText) {
    // Tính kích thước polygon trên màn hình (pixels)
    const sw = map.latLngToContainerPoint(polygonBounds.getSouthWest());
    const ne = map.latLngToContainerPoint(polygonBounds.getNorthEast());
    const polygonWidth = Math.abs(ne.x - sw.x);
    const polygonHeight = Math.abs(sw.y - ne.y);
    
    // Font size cơ bản theo zoom - TỰ ĐỘNG TỐ LÊN KHI ZOOM VÀO
    let baseFontSize;
    if (zoom >= 14) {
        baseFontSize = 18;  // Rất lớn khi zoom gần
    } else if (zoom >= 13) {
        baseFontSize = 16;
    } else if (zoom >= 12) {
        baseFontSize = 14;
    } else if (zoom >= 11) {
        baseFontSize = 12;
    } else if (zoom >= 10) {
        baseFontSize = 10;
    } else if (zoom >= 9) {
        baseFontSize = 9;
    } else if (zoom >= 8) {
        baseFontSize = 8;
    } else {
        baseFontSize = 7;   // Nhỏ nhất khi zoom xa
    }
    
    // Tính kích thước tối đa của text có thể hiển thị trong polygon
    const maxTextWidth = polygonWidth * 0.85;  // 85% chiều rộng polygon
    const maxTextHeight = polygonHeight * 0.7; // 70% chiều cao polygon
    
    // Ước tính kích thước text với font size hiện tại
    const estimatedTextWidth = labelText.length * baseFontSize * 0.6;
    const estimatedTextHeight = baseFontSize * 1.5;
    
    // Điều chỉnh font size nếu text quá lớn cho polygon
    let adjustedFontSize = baseFontSize;
    
    if (estimatedTextWidth > maxTextWidth) {
        adjustedFontSize = Math.floor(maxTextWidth / (labelText.length * 0.6));
    }
    
    if (adjustedFontSize * 1.5 > maxTextHeight) {
        adjustedFontSize = Math.min(adjustedFontSize, Math.floor(maxTextHeight / 1.5));
    }
    
    // Đảm bảo font size tối thiểu là 6px để vẫn đọc được
    adjustedFontSize = Math.max(6, adjustedFontSize);
    
    return adjustedFontSize;
}

// ===== HÀM CẬP NHẬT HIỂN THỊ NHÃN THÔNG MINH =====
function updateLabelVisibility() {
    const zoom = map.getZoom();
    const bounds = map.getBounds();
    
    labelLayers.forEach(item => {
        const { layer, tooltip, polygonBounds, labelText } = item;
        
        // Kiểm tra polygon có trong viewport không
        if (!bounds.intersects(polygonBounds)) {
            tooltip.style.display = 'none';
            return;
        }
        
        // Tính font size thích hợp
        const fontSize = calculateAdaptiveFontSize(polygonBounds, zoom, labelText);
        
        // Kiểm tra text có vừa trong polygon không
        const sw = map.latLngToContainerPoint(polygonBounds.getSouthWest());
        const ne = map.latLngToContainerPoint(polygonBounds.getNorthEast());
        const polygonWidth = Math.abs(ne.x - sw.x);
        const polygonHeight = Math.abs(sw.y - ne.y);
        
        const textWidth = labelText.length * fontSize * 0.6;
        const textHeight = fontSize * 1.5;
        
        // LUÔN HIỂN THỊ nếu text vừa vặn trong polygon
        if (textWidth <= polygonWidth * 0.9 && textHeight <= polygonHeight * 0.8) {
            tooltip.style.display = 'block';
            tooltip.style.fontSize = fontSize + 'px';
        } else {
            // Ẩn nếu không vừa
            tooltip.style.display = 'none';
        }
    });
}

// ===== HÀM ÁP DỤNG STYLE TRỰC TIẾP VÀO TOOLTIP =====
function applyDirectLabelStyles() {
    const tooltips = document.querySelectorAll('.leaflet-tooltip.xa-label');
    
    tooltips.forEach(tooltip => {
        tooltip.style.background = 'none';
        tooltip.style.border = 'none';
        tooltip.style.boxShadow = 'none';
        tooltip.style.padding = '0';
        tooltip.style.pointerEvents = 'none';
        
        tooltip.style.color = '#FFFF00'; 
        tooltip.style.fontWeight = '900';
        tooltip.style.fontFamily = "'Be Vietnam Pro', 'Roboto', Arial, sans-serif";
        tooltip.style.textShadow = '-2px -2px 3px #000, 2px -2px 3px #000, -2px 2px 3px #000, 2px 2px 3px #000, 0 0 8px #000';
        tooltip.style.webkitTextStroke = '1px #000';
        tooltip.style.letterSpacing = '0.3px';
        tooltip.style.whiteSpace = 'nowrap';
    });
    
    // Gọi hàm cập nhật hiển thị
    updateLabelVisibility();
}

// 8. Gọi hàm khi zoom hoặc di chuyển map
map.on('zoomend', applyDirectLabelStyles);
map.on('moveend', updateLabelVisibility);

// 9. Đọc Shapefile Vùng Lúa
const shpZipPath = 'data/VungLuaCLC_3857.zip';

fetch(shpZipPath)
    .then(response => response.arrayBuffer()) 
    .then(buffer => shp.parseZip(buffer)) 
    .then(geojson => {
        const geojsonLayer = L.geoJSON(geojson, {
            style: defaultStyle, 
            onEachFeature: function(feature, layer) {
                layer.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    if (lastClickedLayer) {
                        lastClickedLayer.setStyle(defaultStyle);
                    }
                    layer.setStyle(highlightStyle);
                    lastClickedLayer = layer;
                    
                    const props = feature.properties;
                    let tableContent = '<table>';
                    tableContent += `<thead><tr><th>Tên cột</th><th>Giá trị</th></tr></thead>`;
                    tableContent += '<tbody>';
                    for (let key in props) {
                        tableContent += `<tr><td>${key}</td><td>${props[key]}</td></tr>`;
                    }
                    tableContent += '</tbody></table>';
                    sidebarContent.innerHTML = tableContent;
                    sidebar.classList.add('sidebar-visible');
                });
            }
        }); 
        
        layerControl.addOverlay(geojsonLayer, "Vùng Lúa");
        map.fitBounds(geojsonLayer.getBounds());
    })
    .catch(error => console.error("Lỗi khi đọc file SHP Vùng Lúa:", error));


// ===== 10. TẢI LỚP RANH XÃ VỚI LOGIC ZOOM THÔNG MINH =====
const ranhXaZipPath = 'data/RanhXa_3857.zip'; 

fetch(ranhXaZipPath)
    .then(response => response.arrayBuffer())
    .then(buffer => shp.parseZip(buffer))
    .then(geojson => {
        
        const ranhXaLayer = L.geoJSON(geojson, {
            style: { 
                color: "#C8A2C8", 
                weight: 2, 
                opacity: 0.8, 
                fillOpacity: 0.0 
            },
            interactive: false,
            onEachFeature: function(feature, layer) {
                if (feature.properties && feature.properties.TenXa) {
                    const labelText = feature.properties.TenXa;
                    
                    const labelHtml = `<span style="
                        color: #FFFF00;
                        font-size: 10px;
                        font-weight: 900;
                        font-family: 'Be Vietnam Pro', 'Roboto', Arial, sans-serif;
                        text-shadow: -2px -2px 3px #000, 2px -2px 3px #000, -2px 2px 3px #000, 2px 2px 3px #000, 0 0 8px #000;
                        -webkit-text-stroke: 1px #000;
                        letter-spacing: 0.3px;
                        white-space: nowrap;
                    ">${labelText}</span>`;
                    
                    const tooltip = layer.bindTooltip(labelHtml, {
                        permanent: true,
                        direction: 'center',
                        className: 'xa-label'
                    });

                    layer.openTooltip();
                    
                    labelLayers.push({
                        layer: layer,
                        tooltip: null,
                        polygonBounds: layer.getBounds(),
                        labelText: labelText
                    });
                }
            }
        }).addTo(map);

        setTimeout(() => {
            const tooltips = document.querySelectorAll('.leaflet-tooltip.xa-label');
            tooltips.forEach((tooltipEl, index) => {
                if (labelLayers[index]) {
                    labelLayers[index].tooltip = tooltipEl;
                }
            });
            
            applyDirectLabelStyles();
        }, 500);

        ranhXaLayer.on('add', function() {
            setTimeout(() => {
                applyDirectLabelStyles();
            }, 200);
        });

    })
    .catch(error => {
        console.error("Lỗi khi đọc file SHP Ranh Xã:", error);
        alert("Không thể tải file RanhXa_3857.zip. Kiểm tra đường dẫn file.");
    });

map.whenReady(function() {
    setTimeout(() => {
        applyDirectLabelStyles();
    }, 1000);
});

    </script>
</body>
</html>
