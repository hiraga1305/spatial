<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS - Hoàn Thiện</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
    <script src="https://unpkg.com/shpjs@3.6.2/dist/shp.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    height: 100vh;
    font-family: 'Roboto', Arial, sans-serif;
    overflow: hidden;
}

#map {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
}

/* ===== TOP CONTROLS - NGANG ===== */
.top-controls {
    position: absolute;
    left: 10px;
    top: 10px;
    z-index: 1000;
    display: flex;
    gap: 5px;
}

/* ===== CUSTOM ZOOM CONTROL - NGANG ===== */
.custom-zoom-control {
    display: flex;
    gap: 5px;
}

.zoom-btn {
    width: 30px;
    height: 30px;
    border: none;
    background: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #333;
    transition: background 0.2s;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    border-radius: 4px;
}

.zoom-btn:hover {
    background: rgba(255, 255, 255, 0.95);
}

/* ===== SEARCH BOX - BÊNPHẢI ZOOM ===== */
.search-control {
    background: rgba(255, 255, 255, 0.7);
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    width: 30px;
    height: 30px;
    transition: width 0.3s;
    overflow: hidden;
    display: flex;
}

.search-control.active {
    width: 250px;
}

.search-btn {
    width: 30px;
    height: 30px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    flex-shrink: 0;
}

.search-input {
    border: none;
    background: transparent;
    flex: 1;
    height: 30px;
    padding: 0 10px;
    font-size: 12px;
    font-family: 'Roboto', Arial, sans-serif;
    outline: none;
}

/* ===== CUSTOM LAYER CONTROL - BÊN PHẢI SEARCH ===== */
.custom-layer-control {
    width: 30px;
    height: 30px;
}

.custom-layer-control button {
    width: 30px;
    height: 30px;
    border: none;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    cursor: pointer;
    font-size: 14px;
    color: #333;
    transition: background 0.2s;
}

.custom-layer-control button:hover {
    background: rgba(255, 255, 255, 0.95);
}

.leaflet-control-layers {
    display: none !important;
}

.layer-menu {
    display: none;
    position: absolute;
    left: 0;
    top: 35px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    padding: 10px;
    min-width: 180px;
    z-index: 1001;
}

.layer-menu.active {
    display: block;
}

.layer-menu label {
    display: block;
    padding: 5px 0;
    font-size: 12px;
    cursor: pointer;
    color: #333;
}

.layer-menu input {
    margin-right: 5px;
}

.layer-section {
    margin-bottom: 10px;
}

.layer-section-title {
    font-weight: 600;
    font-size: 11px;
    color: #666;
    margin-bottom: 5px;
    border-bottom: 1px solid #ddd;
}

/* ===== CUSTOM TOOLS ===== */
.custom-tools {
    position: absolute;
    left: 10px;
    bottom: 60px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.tool-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #333;
    transition: all 0.2s;
}

.tool-btn:hover {
    background: rgba(255, 255, 255, 0.95);
    transform: scale(1.05);
}

.tool-btn.active {
    background: rgba(46, 204, 113, 0.9);
    color: white;
}

.tool-btn.clear {
    background: rgba(231, 76, 60, 0.7);
    color: white;
}

.tool-btn.clear:hover {
    background: rgba(231, 76, 60, 0.9);
}

/* ===== SCALE BAR ===== */
.leaflet-control-scale {
    background: rgba(255, 255, 255, 0.7) !important;
    font-size: 11px !important;
    line-height: 1.5 !important;
    padding: 2px 5px !important;
    border-radius: 3px !important;
}

.leaflet-control-scale-line {
    border: 2px solid #333 !important;
    border-top: none !important;
    color: #333 !important;
    font-weight: 600 !important;
}

/* ===== SIDEBAR ===== */
#sidebar {
    position: fixed;
    right: 0;
    top: 0;
    width: 320px;
    height: 100vh;
    background: #ffffff;
    box-shadow: -3px 0 10px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

#sidebar.active {
    transform: translateX(0);
}

.sidebar-header {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
    padding: 12px 15px;
    font-size: 15px;
    font-weight: 600;
    border-bottom: 2px solid #27ae60;
}

.sidebar-header i {
    margin-right: 8px;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    font-size: 13px;
}

.sidebar-content::-webkit-scrollbar {
    width: 6px;
}

.sidebar-content::-webkit-scrollbar-thumb {
    background: #27ae60;
    border-radius: 3px;
}

.sidebar-tabs {
    display: flex;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.sidebar-tab {
    flex: 1;
    padding: 10px 8px;
    text-align: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: #666;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.sidebar-tab:hover {
    background: #e9ecef;
    color: #2ecc71;
}

.sidebar-tab.active {
    color: #2ecc71;
    border-bottom-color: #2ecc71;
    background: white;
}

.info-table {
    width: 100%;
    font-size: 12px;
    border-collapse: collapse;
}

.info-table tr {
    border-bottom: 1px solid #e9ecef;
}

.info-table td {
    padding: 8px 6px;
    line-height: 1.4;
}

.info-table td:first-child {
    font-weight: 600;
    color: #495057;
    width: 40%;
}

.info-message {
    text-align: center;
    padding: 30px 20px;
    color: #6c757d;
    font-size: 13px;
}

.info-message i {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 15px;
    display: block;
}

/* ===== TOGGLE BUTTON ===== */
#sidebar-toggle {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1999;
    background: rgba(46, 204, 113, 0.7);
    color: white;
    border: none;
    width: 30px;
    height: 60px;
    cursor: pointer;
    box-shadow: -3px 0 8px rgba(0, 0, 0, 0.15);
    border-radius: 6px 0 0 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

#sidebar-toggle:hover {
    background: rgba(39, 174, 96, 0.85);
    width: 35px;
}

#sidebar-toggle i {
    font-size: 16px;
    transition: transform 0.3s ease;
}

#sidebar.active + #sidebar-toggle {
    right: 320px;
}

#sidebar.active + #sidebar-toggle i {
    transform: rotate(180deg);
}

/* ===== NHÃN XÃ ===== */
.leaflet-tooltip.xa-label {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
}
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- Top Controls - NGANG -->
    <div class="top-controls">
        <!-- Zoom Control -->
        <div class="custom-zoom-control">
            <button class="zoom-btn" id="zoom-in" title="Phóng to">
                <i class="fas fa-plus"></i>
            </button>
            <button class="zoom-btn" id="zoom-out" title="Thu nhỏ">
                <i class="fas fa-minus"></i>
            </button>
        </div>

        <!-- Search Control -->
        <div class="search-control" id="search-control">
            <button class="search-btn" id="search-btn">
                <i class="fas fa-search"></i>
            </button>
            <input type="text" class="search-input" id="search-input" placeholder="Tìm kiếm...">
        </div>

        <!-- Layer Control -->
        <div class="custom-layer-control">
            <button id="layer-btn" title="Quản lý lớp">
                <i class="fas fa-layer-group"></i>
            </button>
            <div class="layer-menu" id="layer-menu">
                <div class="layer-section">
                    <div class="layer-section-title">BẢN ĐỒ NỀN</div>
                    <label>
                        <input type="radio" name="basemap" value="satellite" checked>
                        Vệ tinh (Esri)
                    </label>
                    <label>
                        <input type="radio" name="basemap" value="osm">
                        OpenStreetMap
                    </label>
                </div>
                <div class="layer-section">
                    <div class="layer-section-title">LỚP PHỦ</div>
                    <label>
                        <input type="checkbox" id="layer-carto">
                        Chỉ dẫn
                    </label>
                    <label>
                        <input type="checkbox" id="layer-vunglua" checked>
                        Vùng Lúa
                    </label>
                    <label>
                        <input type="checkbox" id="layer-ranhxa" checked>
                        Ranh Xã
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Tools -->
    <div class="custom-tools">
        <button class="tool-btn" id="measure-distance" title="Đo khoảng cách">
            <i class="fas fa-ruler"></i>
        </button>
        <button class="tool-btn" id="measure-area" title="Đo diện tích">
            <i class="fas fa-draw-polygon"></i>
        </button>
        <button class="tool-btn" id="my-location" title="Vị trí của tôi">
            <i class="fas fa-location-dot"></i>
        </button>
        <button class="tool-btn clear" id="clear-measures" title="Xóa các đo đạc">
            <i class="fas fa-trash"></i>
        </button>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <span><i class="fas fa-info-circle"></i>Thông tin chi tiết</span>
        </div>
        
        <div class="sidebar-tabs">
            <div class="sidebar-tab active" onclick="switchTab('info')">
                <i class="fas fa-map"></i> Bản đồ
            </div>
            <div class="sidebar-tab" onclick="switchTab('layers')">
                <i class="fas fa-layer-group"></i> Lớp
            </div>
            <div class="sidebar-tab" onclick="switchTab('analysis')">
                <i class="fas fa-chart-bar"></i> Phân tích
            </div>
        </div>
        
        <div class="sidebar-content" id="sidebar-content">
            <div class="info-message">
                <i class="fas fa-mouse-pointer"></i>
                <p>Click vào một thửa đất trên bản đồ để xem thông tin chi tiết</p>
            </div>
        </div>
    </div>

    <button id="sidebar-toggle" onclick="toggleSidebar()" title="Mở/Đóng thông tin">
        <i class="fas fa-chevron-left"></i>
    </button>

    <script>
// ===== KHỞI TẠO BẢN ĐỒ =====
const map = L.map('map', {
    zoomControl: false
}).setView([10.7769, 106.7009], 10);

const osm = L.tileLayer.provider('OpenStreetMap.Mapnik');
const esriSatellite = L.tileLayer.provider('Esri.WorldImagery').addTo(map);
const cartoLabels = L.tileLayer.provider('CartoDB.PositronOnlyLabels');

L.control.scale({
    position: 'bottomleft',
    metric: true,
    imperial: false,
    maxWidth: 100
}).addTo(map);

// ===== CUSTOM ZOOM CONTROL =====
document.getElementById('zoom-in').addEventListener('click', () => {
    map.zoomIn();
});

document.getElementById('zoom-out').addEventListener('click', () => {
    map.zoomOut();
});

// ===== SEARCH CONTROL =====
const searchControl = document.getElementById('search-control');
const searchBtn = document.getElementById('search-btn');
const searchInput = document.getElementById('search-input');

searchBtn.addEventListener('click', () => {
    searchControl.classList.toggle('active');
    if (searchControl.classList.contains('active')) {
        searchInput.focus();
    }
});

searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        alert('Tìm kiếm: ' + searchInput.value);
    }
});

// ===== CUSTOM LAYER CONTROL =====
const layerBtn = document.getElementById('layer-btn');
const layerMenu = document.getElementById('layer-menu');

layerBtn.addEventListener('click', () => {
    layerMenu.classList.toggle('active');
});

document.addEventListener('click', (e) => {
    if (!layerBtn.contains(e.target) && !layerMenu.contains(e.target)) {
        layerMenu.classList.remove('active');
    }
});

document.querySelectorAll('input[name="basemap"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        if (e.target.value === 'satellite') {
            map.removeLayer(osm);
            map.addLayer(esriSatellite);
        } else {
            map.removeLayer(esriSatellite);
            map.addLayer(osm);
        }
    });
});

document.getElementById('layer-carto').addEventListener('change', (e) => {
    if (e.target.checked) {
        map.addLayer(cartoLabels);
    } else {
        map.removeLayer(cartoLabels);
    }
});

// ===== ĐO KHOẢNG CÁCH VÀ DIỆN TÍCH =====
let measureMode = null;
let drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const measureDistance = document.getElementById('measure-distance');
const measureArea = document.getElementById('measure-area');
const clearMeasures = document.getElementById('clear-measures');

measureDistance.addEventListener('click', () => {
    if (measureMode === 'distance') {
        stopMeasure();
    } else {
        startMeasure('distance');
    }
});

measureArea.addEventListener('click', () => {
    if (measureMode === 'area') {
        stopMeasure();
    } else {
        startMeasure('area');
    }
});

clearMeasures.addEventListener('click', () => {
    drawnItems.clearLayers();
    if (locationMarker) {
        map.removeLayer(locationMarker);
        locationMarker = null;
    }
    if (locationCircle) {
        map.removeLayer(locationCircle);
        locationCircle = null;
    }
});

function startMeasure(mode) {
    stopMeasure();
    measureMode = mode;
    
    if (mode === 'distance') {
        measureDistance.classList.add('active');
        new L.Draw.Polyline(map, {
            shapeOptions: {
                color: '#ff0000',
                weight: 3
            }
        }).enable();
    } else if (mode === 'area') {
        measureArea.classList.add('active');
        new L.Draw.Polygon(map, {
            shapeOptions: {
                color: '#0000ff',
                weight: 3,
                fillOpacity: 0.3
            }
        }).enable();
    }
}

function stopMeasure() {
    measureDistance.classList.remove('active');
    measureArea.classList.remove('active');
    measureMode = null;
}

map.on(L.Draw.Event.CREATED, (e) => {
    const layer = e.layer;
    drawnItems.addLayer(layer);
    
    if (e.layerType === 'polyline') {
        const distance = calculateDistance(layer.getLatLngs());
        alert('Khoảng cách: ' + distance.toFixed(2) + ' m');
    } else if (e.layerType === 'polygon') {
        const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        alert('Diện tích: ' + area.toFixed(2) + ' m²');
    }
    
    stopMeasure();
});

function calculateDistance(latlngs) {
    let distance = 0;
    for (let i = 0; i < latlngs.length - 1; i++) {
        distance += latlngs[i].distanceTo(latlngs[i + 1]);
    }
    return distance;
}

// ===== VỊ TRÍ CỦA TÔI =====
const myLocation = document.getElementById('my-location');
let locationMarker = null;
let locationCircle = null;

myLocation.addEventListener('click', () => {
    map.locate({setView: true, maxZoom: 16});
});

map.on('locationfound', (e) => {
    if (locationMarker) map.removeLayer(locationMarker);
    if (locationCircle) map.removeLayer(locationCircle);
    
    locationMarker = L.marker(e.latlng, {
        icon: L.divIcon({
            className: 'my-location-icon',
            html: '<i class="fas fa-circle" style="color: #2ecc71; font-size: 20px;"></i>',
            iconSize: [20, 20]
        })
    }).addTo(map);
    
    locationCircle = L.circle(e.latlng, e.accuracy).addTo(map);
});

map.on('locationerror', (e) => {
    alert('Không thể xác định vị trí: ' + e.message);
});

// ===== SIDEBAR =====
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebar-content');
let lastClickedLayer = null;

function toggleSidebar() {
    sidebar.classList.toggle('active');
}

function switchTab(tabName) {
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.closest('.sidebar-tab').classList.add('active');
    
    if (tabName === 'layers') {
        sidebarContent.innerHTML = '<div class="info-message"><i class="fas fa-layer-group"></i><p>Quản lý các lớp dữ liệu</p></div>';
    } else if (tabName === 'analysis') {
        sidebarContent.innerHTML = '<div class="info-message"><i class="fas fa-chart-bar"></i><p>Công cụ phân tích</p></div>';
    }
}

map.on('click', function() {
    if (lastClickedLayer) {
        lastClickedLayer.setStyle(defaultStyle);
        lastClickedLayer = null;
    }
    sidebarContent.innerHTML = '<div class="info-message"><i class="fas fa-mouse-pointer"></i><p>Click vào một thửa đất</p></div>';
});

const defaultStyle = {
    color: "#ff7800",
    weight: 2,
    opacity: 0.8,
    fillColor: "#ff7800",
    fillOpacity: 0.3
};

const highlightStyle = {
    color: "#00FFFF",
    weight: 4,
    opacity: 1,
    fillColor: "#00FFFF",
    fillOpacity: 0.5
};

// ===== NHÃN XÃ =====
let labelLayers = [];
const HIDE_ZOOM_THRESHOLD = 16;

function updateLabelVisibility() {
    const zoom = map.getZoom();
    const bounds = map.getBounds();
    
    labelLayers.forEach(item => {
        const { tooltip, polygonBounds } = item;
        
        if (zoom >= HIDE_ZOOM_THRESHOLD || !bounds.intersects(polygonBounds)) {
            tooltip.style.display = 'none';
        } else {
            tooltip.style.display = 'block';
        }
    });
}

function applyDirectLabelStyles() {
    const tooltips = document.querySelectorAll('.leaflet-tooltip.xa-label');
    
    tooltips.forEach(tooltip => {
        tooltip.style.background = 'none';
        tooltip.style.border = 'none';
        tooltip.style.boxShadow = 'none';
        tooltip.style.padding = '0';
        tooltip.style.pointerEvents = 'none';
        tooltip.style.fontSize = '9px';
        tooltip.style.color = '#000000';
        tooltip.style.fontWeight = '600';
        tooltip.style.fontFamily = 'Roboto, Arial, sans-serif';
        tooltip.style.textShadow = '-1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff';
        tooltip.style.whiteSpace = 'nowrap';
    });
    
    updateLabelVisibility();
}

map.on('zoomend', updateLabelVisibility);
map.on('moveend', updateLabelVisibility);

// ===== ĐỌC SHAPEFILE =====
const shpZipPath = 'data/VungLuaCLC_3857.zip';
let vungLuaLayer = null;

fetch(shpZipPath)
    .then(response => response.arrayBuffer())
    .then(buffer => shp.parseZip(buffer))
    .then(geojson => {
        vungLuaLayer = L.geoJSON(geojson, {
            style: defaultStyle,
            onEachFeature: function(feature, layer) {
                layer.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    if (lastClickedLayer) lastClickedLayer.setStyle(defaultStyle);
                    layer.setStyle(highlightStyle);
                    lastClickedLayer = layer;
                    
                    const props = feature.properties;
                    let tableContent = '<table class="info-table">';
                    for (let key in props) {
                        tableContent += `<tr><td>${key}</td><td>${props[key]}</td></tr>`;
                    }
                    tableContent += '</table>';
                    sidebarContent.innerHTML = tableContent;
                    sidebar.classList.add('active');
                });
            }
        }).addTo(map);
        
        document.getElementById('layer-vunglua').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(vungLuaLayer);
            } else {
                map.removeLayer(vungLuaLayer);
            }
        });
        
        map.fitBounds(vungLuaLayer.getBounds());
    })
    .catch(error => console.error("Lỗi:", error));

const ranhXaZipPath = 'data/RanhXa_3857.zip';
let ranhXaLayer = null;

fetch(ranhXaZipPath)
    .then(response => response.arrayBuffer())
    .then(buffer => shp.parseZip(buffer))
    .then(geojson => {
        ranhXaLayer = L.geoJSON(geojson, {
            style: {
                color: "#C8A2C8",
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.0
            },
            interactive: false,
            onEachFeature: function(feature, layer) {
                if (feature.properties && feature.properties.TenXa) {
                    const labelText = feature.properties.TenXa;
                    const tooltip = layer.bindTooltip(`<span>${labelText}</span>`, {
                        permanent: true,
                        direction: 'center',
                        className: 'xa-label'
                    });
                    layer.openTooltip();
                    labelLayers.push({
                        layer: layer,
                        tooltip: null,
                        polygonBounds: layer.getBounds(),
                        labelText: labelText
                    });
                }
            }
        }).addTo(map);

        document.getElementById('layer-ranhxa').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(ranhXaLayer);
            } else {
                map.removeLayer(ranhXaLayer);
            }
        });

        setTimeout(() => {
            const tooltips = document.querySelectorAll('.leaflet-tooltip.xa-label');
            tooltips.forEach((tooltipEl, index) => {
                if (labelLayers[index]) {
                    labelLayers[index].tooltip = tooltipEl;
                }
            });
            applyDirectLabelStyles();
        }, 500);
    })
    .catch(error => console.error("Lỗi:", error));

map.whenReady(() => {
    setTimeout(() => applyDirectLabelStyles(), 1000);
});
    </script>
</body>
</html>
